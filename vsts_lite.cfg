// Vslot Text Sender Lite by Salatiel (v 27/04/2025)
// This version does not include the vshadereditor.

vsts_attribute_get = [arg2 = (concatword $arg2 ":"); arg2 = (substr $arg1 (+ (strstr $arg1 $arg2) (strlen $arg2))); substr $arg2 0 (strstr $arg2 "|")]
vsts_attribute_edit = [
	strreplace $arg1 (concatword $arg2 ":" (vsts_attribute_get $arg1 $arg2) "|") (concatword $arg2 ":" $arg3 "|")
]

vsts_string_to_code = [
	loopconcatword s (strlen $arg1) [
		local n
		n = (strcode $arg1 $s)
		format "%1%2" $n (loopconcatword p (- 3 (strlen $n)) [result "!"])
	]
]

vsts_code_to_string = [
	loopconcatword c (strlen $arg1) [ codestr (substr $arg1 (* $c 3) 3) ]
]

vsts_write = [
	local coded i d coded_unique param_length
	coded = (vsts_string_to_code $arg1)
	i = 0
	d = 0
	param_length = (? (=s $arg3 "") 250 $arg3)

	if (!= $arg2 1) [
		while [<= $d (strlen $coded)] [
			if (> (rnd 100) 50) [
				appendword coded_unique "-"
			] [
				appendword coded_unique (substr $coded $d 1)
				d = (+ $d 1)
			]
		]
		coded = $coded_unique
	]

	vdelta [
		while [<= $i (strlen $coded)] [
			vshaderparam (format "%1%2%3" (? (= $i 0) "[" "") (substr $coded $i $param_length) (? (>= (+ $i $param_length) (strlen $coded)) "]" ""))
			i = (+ $i $param_length)
		]
	]
	compactvslots
]

vsts_join = [
	local paramnames
	paramnames = (strreplace (strreplace (getvshaderparamnames $arg1) "-" "") " " "")
	looplist customuniform $_vshe_mapshader_uniforms [
		local shadername
		shadername = (at $_vshe_mapshader_uniforms 0)
		paramnames = (strreplace $paramnames $shadername "")
	]
	result $paramnames
]

vsts_get_by_slot = [
	local params
	params = (vsts_join $arg1)
	result $params
]

vsts_get_by_match = [
	compactvslots
	local code_match search_slot all_slots match_start match_end
	code_match = (vsts_string_to_code $arg1)
	search_slot = (numslots)
	match_start = $arg2
	match_end = $arg3

	all_slots = []

	while [<= $search_slot (numvslots)] [
		append all_slots (looplistconcat s (vsts_get_by_slot $search_slot) [result (format "[%1]" $s)])
		search_slot = (+ $search_slot 1)
	]
	
	? (!=s $code_match "") (listfilter m $all_slots [!= (strstr (? (=s $match_start "") $m (substr $m $match_start $match_end)) $code_match) -1]) $all_slots
]

vsts_read = [
	local by_slot by_match final_result
	by_slot = (vsts_get_by_slot $arg1)
	by_match =  (vsts_get_by_match $arg1 $arg2 $arg3)
	final_result = (looplistconcat str (concat (listfilter bs $by_slot [= (strstr $by_match $bs) -1]) $by_match) [format "[%1]" (vsts_code_to_string $str)])
	result $final_result
]

_vsts_echo = [
	echo (format "^f7[VSTS-0.1^f~] %1" $arg1)
]

_vsts_echo "Vslot Text Sender Lite loaded"